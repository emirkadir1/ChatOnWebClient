@{
    ViewData["Title"] = "Message";
}
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="~/css/chat.css" rel="stylesheet" />
<audio id="notificationSound" src="~/lib/notification.mp3"></audio>
<div class="container">
    <div class="row clearfix">
        <div class="col-lg-12">
            <div class="card chat-app" style="width:1296px;height:800px;">

                <div id="plist" class="people-list">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" placeholder="Search..." id="searchInput">
                    </div>
                    <!-- Users -->
                    <div class="row" style="width:264px;height:700px; overflow:auto;">

                            <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                                <ul class="list-unstyled chat-list mt-2 mb-0" id="users">
                                </ul>
                            </div>
                    </div>


                </div>
                <!-- User Header-->

                <div class="chat">
                    <div class="chat-header clearfix">
                        <div class="row">
                            <div class="col-lg-6" id="userHeader">

                            </div>

                        </div>
                    </div>
                    <!-- Chat History -->

                    <div class="chat-history" style="width:1015px;height:600px; overflow:auto;">
                        <ul class="m-b-0" id="messagesList">
                            
                        </ul>
                    </div>
                    <!-- Message Send -->
                    <div class="chat-message clearfix">
                        <div class="input-group mb-0">
                            <div class="input-group-prepend">
                                <button class="btn btn-outline-primary" type="submit" id="sendButton"><span class="input-group-text"><i class="fa fa-send"></i></span></button>
                            </div>
                            <input type="text" class="form-control" placeholder="Enter text here..." id="messageInput">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




@*
<main class="content">
    <div class="container p-0">

        <h1 class="h3 mb-3">Messages</h1>

        <div class="card">
            <div class="row g-0">
                <div class="col-12 col-lg-5 col-xl-3 border-right">

                    <div class="px-4 d-none d-md-block">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <input type="text" class="form-control my-3" placeholder="Search..." id="searchInput">
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item list-group-item-action border-0">
                        <div class="badge bg-success float-right">5</div>
                        <div class="d-flex align-items-start">
                            <img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">
                            <div class="flex-grow-1 ml-3">
                                Vanessa Tucker
                                <div class="small"><span class="fa fa-circle online"></span> Online</div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item list-group-item-action border-0">
                        <div class="d-flex align-items-start">
                            <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Jennifer Chang" width="40" height="40">
                            <div class="flex-grow-1 ml-3">
                                Jennifer Chang
                                <div class="small"><span class="fa fa-circle offline"></span> Offline</div>
                            </div>
                        </div>
                    </div>
                     <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                                <ul class="list-unstyled chat-list mt-2 mb-0" id="users">
                                </ul>
                            </div>
                    <hr class="d-block d-lg-none mt-1 mb-0">
                </div>
                <div class="col-12 col-lg-7 col-xl-9">
                    <div class="py-2 px-4 border-bottom d-none d-lg-block">
                        <div class="d-flex align-items-center py-1">
                            <div class="position-relative">
                                <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                            </div>
                            <div class="flex-grow-1 pl-3">
                                <strong>Sharon Lessman</strong>
                                <div class="text-muted small"><em>Typing...</em></div>
                            </div>
                            <div>
                                <button class="btn btn-primary btn-lg mr-1 px-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-phone feather-lg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></button>
                                <button class="btn btn-info btn-lg mr-1 px-3 d-none d-md-inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video feather-lg"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
                                <button class="btn btn-light border btn-lg px-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal feather-lg"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button>
                            </div>
                        </div>
                    </div>

                    <div class="position-relative">
                        <div class="chat-messages p-4">

                            <div class="chat-message-right pb-4">
                                <div>
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                                    <div class="text-muted small text-nowrap mt-2">2:33 am</div>
                                </div>
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                                    <div class="font-weight-bold mb-1">You</div>
                                    Lorem ipsum dolor sit amet, vis erat denique in, dicunt prodesset te vix.
                                </div>
                            </div>

                            <div class="chat-message-left pb-4">
                                <div>
                                    <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                                    <div class="text-muted small text-nowrap mt-2">2:44 am</div>
                                </div>
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                                    <div class="font-weight-bold mb-1">Sharon Lessman</div>
                                    Sit meis deleniti eu, pri vidit meliore docendi ut, an eum erat animal commodo.
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="flex-grow-0 py-3 px-4 border-top">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Type your message">
                            <button class="btn btn-primary">Send</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</main>*@
<script src="~/js/signalr/dist/browser/signalr.js"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
@section scripts {
    <script>
        var joinedUser = '@ViewBag.UserName';
                // Burada joinedUser kullanarak yapmak istediğiniz işlemi gerçekleştirebilirsiniz
        var connection = new signalR.HubConnectionBuilder().withUrl("https://localhost:7212/ChatHub").withAutomaticReconnect().build();
        var targetUser = "";
        //Log In in start
        connection.start().then(function () {
            connection.invoke("GetUserName",joinedUser).catch(function (err) {
                return console.error(err.toString());
            });

        }).catch(function (err) {
            return console.error(err.toString());
        });
        //All Users
        connection.on("Users", function (usersList) {
            const userList = document.getElementById("users");
            userList.innerHTML = "";
            usersList.forEach(function (user) {
                const listItem = document.createElement("li");
                if (user.online) {
                    var str = `<li class="clearfix" id="user" onclick="getUser(this)"><img src="${user.imageUrl}" alt="avatar"><div class="about"><div class="name" id="userName"> ${user.userName}</div><div class="row p-1"></div><div class="status"> <i class="fa fa-circle online"></i></div><div id="sideMessage"></div></div></li> `
                }
                else {
                    var str = `<li class="clearfix" id="user" onclick="getUser(this)"><img src="${user.imageUrl}" alt="avatar"><div class="about"><div class="name" id="userName"> ${user.userName}</div><div class="row p-1"></div><div class="status"> <i class="fa fa-circle offline"></i></div><div id="sideMessage"></div></div></li> `
                }

                listItem.innerHTML = str;
                userList.appendChild(listItem);
            });
        });
        connection.on("ReceiveMessageMine", function (user, message, time) {
            var li = document.createElement("li");
            var str = `<li class="clearfix"><div class="message-data text-right"style="margin-left: 760px;"><span class="message-data-time">${time} ${user.userName}</span></div> <div class="message other-message float-right"> \n ${message} </div></li>`;
            document.getElementById("messagesList").appendChild(li);
            li.innerHTML = str;
            var notificationSound = document.getElementById("notificationSound");
            notificationSound.play();
            // Tüm li elementleri seç
            var liElements = document.querySelectorAll("li#user");

            // li elementlerini döngüyle gez
            for (var i = 0; i < liElements.length; i++) {
                // Seçilen li elementindeki userName div'ini seç
                var userNameDiv = liElements[i].querySelector("div#userName");

                // Seçilen kullanıcının userName etiketiyle eşleşiyorsa
                if (userNameDiv.textContent === targetUser) {
                    // Li elementinin sideMessage div'inin textcontent'ini değiştir
                    var sideMessageDiv = liElements[i].querySelector("div#sideMessage");
                    if (message.length < 14) {
                        sideMessageDiv.textContent = '\n ' + message.substring(0, 12);
                    }
                    else {
                        sideMessageDiv.textContent = '\n ' + message.substring(0, 12) + '...';
                    }

                }
            }

        });

        connection.on("ReceiveMessageFromOthers", function (user, message, time) {

            const _userName = user.userName
            if (_userName.trim() === targetUser.trim()) {
                var li = document.createElement("li");
                var str = `<li class="clearfix"><div class="message-data"><span class="message-data-time">${time} ${user.userName}</span></div><div class="message my-message"> \n ${message}</div></li>`;
                document.getElementById("messagesList").appendChild(li);
                li.innerHTML = str;
                var notificationSound = document.getElementById("notificationSound");
                notificationSound.play();
            }
            var liElements = document.querySelectorAll("li#user");
            // li elementlerini döngüyle gez
            for (var i = 0; i < liElements.length; i++) {
                // Seçilen li elementindeki userName div'ini seç
                var userNameDiv = liElements[i].querySelector("div#userName");
                // Seçilen kullanıcının userName etiketiyle eşleşiyorsa
                if (userNameDiv.textContent.trim() === _userName.trim()) {
                    // Li elementinin sideMessage div'inin textcontent'ini değiştir
                    var sideMessageDiv = liElements[i].querySelector("div#sideMessage");
                    if (message.length < 14) {
                        sideMessageDiv.textContent = '\n ' + message.substring(0, 12);
                    }
                    else {
                        sideMessageDiv.textContent = '\n ' + message.substring(0, 12) + '...';
                    }

                }
            }
        });


        // ShowMessages
        connection.on("ShowMessages", function (messages) {
            document.getElementById("messagesList").innerHTML = "";
            messages.forEach(function (message) {
                if (message.sender.userName == joinedUser.trim() && message.reciver.userName == targetUser.trim()) {
                    var listItem = document.createElement("li");
                    var str = `<li class="clearfix"><div class="message-data text-right"style="margin-left: 760px;"><span class="message-data-time ">${message.createdTime} ${message.sender.userName}</span> </div> <div class="message other-message float-right"> \n ${message.body} </div></li>`;
                    listItem.innerHTML = str;
                    document.getElementById("messagesList").appendChild(listItem);
                }
                if (message.sender.userName == targetUser.trim() && message.reciver.userName == joinedUser.trim()) {
                    var listItem = document.createElement("li");
                    var str = `<li class="clearfix"><div class="message-data text-left"><span class="message-data-time">${message.createdTime} ${message.sender.userName}</span></div><div class="message my-message">${message.body}</div></li>`;
                    listItem.innerHTML = str;
                    document.getElementById("messagesList").appendChild(listItem);
                }
            });

        });

        // Send Message
        document.getElementById("sendButton").addEventListener("click", function (event) {
            var message = document.getElementById("messageInput").value;
            connection.invoke("SendMessage", joinedUser, targetUser, message).catch(function (err) {
                return console.error(err.toString());
            });
            event.preventDefault();
        });

        //Current User
        function getUser(user) {
            var _user = user // tıklanan resmin image url'sini al
            targetUser = user.querySelector("div#userName").innerHTML;
            //var header = `<div class="col-lg-6" id="userHeader"> <h6 class="m-b-0">${targetUser}</h6><small>Last seen: 2 hours ago</small></div>`;
            // burada istediğiniz şekilde image url stringini kullanabilirsiniz
            document.getElementById("userHeader").innerHTML = _user.innerHTML;
            if (targetUser != '') {
                connection.invoke("GetMessages", joinedUser, targetUser).catch(function (err) {
                    return console.error(err.toString());
                });
            }
        }

        //User filter
        // search inputunu ve ul etiketini yakala
        const searchInput = document.getElementById('searchInput');
        const _userList = document.getElementById('users');

        // search inputunda herhangi bir değer değiştiğinde çalışacak fonksiyonu tanımla
        searchInput.addEventListener('input', function (event) {
            // girilen değeri al
            const searchText = event.target.value.toLowerCase();
            // li elementlerini al
            const users = _userList.getElementsByTagName('li');

            // her bir li elementinin içindeki userName div elementini kontrol et
            for (let i = 0; i < users.length; i++) {
                const userName = users[i].querySelector('#userName');
                const nameValue = userName.textContent.toLowerCase();

                // girilen değer ile userName içindeki text karşılaştır
                if (nameValue.includes(searchText)) {
                    // eşleşme varsa li elementini görünür yap
                    users[i].style.display = 'block';
                } else {
                    // eşleşme yoksa li elementini gizle
                    users[i].style.display = 'none';
                }
            }
        });

    </script>
}

